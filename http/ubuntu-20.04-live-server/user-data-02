#cloud-config
autoinstall:

  early-commands:
    - systemctl stop ssh  # Prevent Packer from hanging

  ## Ensure we get the latest installer possible
  refresh-installer:
    channel: 'stable'
    update: yes

  # ## Setup network
#network:
  network:
    version: 2
    ethernets:
      enp3s0:
        dhcp4: true
        dhcp-identifier: mac
        nameservers:
          addresses: [192.168.122.1, 1.1.1.1]
          search: [home.lan]

  ## Setup apt repos
  apt:
    geoip: true
    preserve_sources_list: false
    primary:
    - arches: [amd64]
      uri: http://es.archive.ubuntu.com/ubuntu
    - arches: [default]
      uri: http://ports.ubuntu.com/ubuntu-ports

  ## Setup user account and hostname. This section is mutually exclusive of users:
  # identity:
  #   hostname: ubuntu01
  #   password: $6$XqukfRfkhEppZVYU$oDaAkNMWBJR9BSIm43xGas3GwtRrwmheShFDP1y/USq1k5cQayUoUXAHjXSBiLDWXWU0y6Fdc1i6prfgOblKj1
  #   realname: ansible
  #   username: ansible

  ## Setup the keyboard and locale
  keyboard:
    layout: us
    variant: ''
  locale: en_US.UTF-8

  ## Extra settings
  user-data:
    hostname: ubuntu-01
    disable_root: true
    users:
      - name: ansible
        gecos: "Ansible automation"
        groups: users,sudo
        ssh_import_id: "gh:donhector"
        lock-passwd: false
        passwd: $6$XqukfRfkhEppZVYU$oDaAkNMWBJR9BSIm43xGas3GwtRrwmheShFDP1y/USq1k5cQayUoUXAHjXSBiLDWXWU0y6Fdc1i6prfgOblKj1
        shell: /bin/bash
        sudo: ALL=(ALL) NOPASSWD:ALL
    timezone: Europe/Madrid
    ntp:
      enabled: true

  ## Configure SSH server and authorized keys
  ssh:
    allow-pw: true
    authorized-keys: ['ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQC5WfCjR/QAokmUwjbPryswhHhNCRLI79BTR8dUcpvfFYRrrEY62YewWTyxXANcARXogL4c4z9fvaUBK3ifZ8vEAMSEDCEfpI0AN63k/aQUc+8cP/n92lFOWa8ZvqQvr/VBNH6r18RJinJ4+HZYBNuY9hAHTTvivtnfMNOBL38ouWhE5WYY6FnW4li15bPJL97ey34evATUaFZP8uDUSngv//k7kHXKp6vMIqCMu5lQTcV/4hcakuZ7TYBz07JCoHO+BpZyE9NLwBiapETK+p7lPnVBWRYaWgFJYSiFMFsPYCTbeV+QlBXCRdK8fjVN7h+9h4Va09E/B3FrItx2GFcvC5llH052ADrW5L3eX8G6B/gz8DpbAQXPvvi5puT3zahYaTrv45fWIl6a+ABFoJRYcBPwu/atHF2lCsJ+P0FmJekZsrEx3KNaBWUAyKkdVetQ7BBXFN4rihmP0yGUdBOuNXmIuOnxdjeisO1zhpyYmGM6zfvhGiP5BhRxCq+CdRT59VatlJuSx5NPvU+feul/xjGKbLQw8m7T9uFwrSXZvw2ve1/tgeDg5ivLoIhixaeks0gBamrk+Z/7Psd8mQtVKTbM/xxKxSqXxUqY2mEmP8q4jjQWaf4xIKrlAGMFTz3KUWVKksjU82VIgf82hD8N5HVPaffgnqi87uRWFdSHPw==
        donhector@github/49699159 # ssh-import-id gh:donhector', '', 'ssh-ed25519
        AAAAC3NzaC1lZDI1NTE5AAAAIBYOzTJoN5TImhjMTw9gYzYJiDIK5NHMAbJ8OXxvDX2W donhector@github/58404365
        # ssh-import-id gh:donhector']
    install-server: true
  
  ## Configure storage (default layout is lvm)
  storage:    
    layout:
      name: lvm
  
  ## Update apt database and upgrade packages on first boot
  package_update: true
  package_upgrade: true

  # ## Install additional packages
  packages:
    - ansible
    - build-essential

  ## Run arbitrary post install commands
  late-commands:
    - echo 'ansible ALL=(ALL) NOPASSWD:ALL' > /target/etc/sudoers.d/ansible
  #   - chmod 440 /target/etc/sudoers.d/ansible
  #   ## Enable old iface naming convetion suchs as eth0, wlan0 and disble ipv6
  #   - sed -ie 's/GRUB_CMDLINE_LINUX=.*/GRUB_CMDLINE_LINUX="net.ifnames=0 ipv6.disable=1"/' /target/etc/default/grub
  #   - curtin in-target --target=/target update-grub2
  #   - curtin in-target --target=/target -- /bin/sh -c -- 'ANSIBLE_LOG_PATH=/var/log/ansible.log ansible -m ping -o -a data=SMOKETEST localhost'
    - apt update
    - apt -y install linux-headers-$(uname -r)
  #   - apt -y dist-upgrade
  #   ## Disable swap
  #   # - swapoff -a
  #   # - sed -i '/^\/swap.img/d' /target/etc/fstab
  #   # - rm -f /target/swap.img

  
  final_message: "The system is finally up, after $UPTIME seconds"

  ## Receive security updates
  updates: security
  version: 1

# bootcmd:
    #- [wget,"http://some.server/cloud-init/post-install.sh", -O, /root/post-install.sh]